# æ–‡ä»¶å: build.yml
name: Build and Push GHCR Docker Image (Manual Trigger)

on:
  workflow_dispatch:
    inputs:
      version_to_build:
        description: 'éœ€è¦æž„å»ºå’ŒæŽ¨é€çš„ç‰ˆæœ¬å· (ä¾‹å¦‚: v1.0.38)'
        required: true
      skip_cache:
        description: 'è·³è¿‡æ‰€æœ‰ç¼“å­˜ï¼Œè¿›è¡Œå…¨æ–°æž„å»º'
        required: false
        default: false # æŽ¨èå°†å¸ƒå°”å€¼ç›´æŽ¥è®¾ä¸º falseï¼Œè€Œä¸æ˜¯å­—ç¬¦ä¸² 'false'
        type: boolean
      overwrite_existing:
        description: 'å¦‚æžœé•œåƒæ ‡ç­¾å·²å­˜åœ¨ï¼Œæ˜¯å¦è¦†ç›–å®ƒ'
        required: false
        default: false # æŽ¨èå°†å¸ƒå°”å€¼ç›´æŽ¥è®¾ä¸º false
        type: boolean

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    # ä½¿ç”¨ outputs å°†å‡†å¤‡å¥½çš„å˜é‡ä¼ é€’ç»™åŽç»­æ­¥éª¤
    outputs:
      image_tag: ${{ steps.prepare.outputs.IMAGE_TAG }}
      owner_lc: ${{ steps.prepare.outputs.OWNER_LC }}
      image_exists: ${{ steps.check_image.outputs.image_exists }}

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. ä¼˜åŒ–ï¼šå‡†å¤‡å¹¶éªŒè¯æ‰€æœ‰éœ€è¦çš„å˜é‡ (åˆå¹¶äº†åŽŸæœ‰çš„ç‰ˆæœ¬éªŒè¯å’Œä»“åº“åè½¬æ¢)
      - name: Prepare and validate variables
        id: prepare
        run: |
          # éªŒè¯ç‰ˆæœ¬å·
          version="${{ github.event.inputs.version_to_build }}"
          if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç‰ˆæœ¬æ ¼å¼: $versionï¼ŒæœŸæœ›æ ¼å¼ä¸º: v1.2.3"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬æ ¼å¼æœ‰æ•ˆ: $version"
          echo "IMAGE_TAG=$version" >> $GITHUB_OUTPUT

          # å‡†å¤‡å°å†™çš„ä»“åº“æ‰€æœ‰è€…åç§°
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_LC=${OWNER_LC}" >> $GITHUB_OUTPUT
          echo "NPM_VERSION=${version#v}" >> $GITHUB_OUTPUT

      # 3. ç™»å½•åˆ° GitHub Container Registry (GHCR)
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. ä¼˜åŒ–ï¼šæ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨ (ä»…åœ¨ä¸è¦†ç›–æ—¶è¿è¡Œ)
      - name: Check if Docker image already exists
        id: check_image
        # ä»…å½“ç”¨æˆ·ä¸å¸Œæœ›è¦†ç›–æ—¶ï¼Œæ‰æ‰§è¡Œæ­¤æ£€æŸ¥
        if: "!github.event.inputs.overwrite_existing"
        run: |
          IMAGE_NAME="ghcr.io/${{ steps.prepare.outputs.OWNER_LC }}/ccr:${{ steps.prepare.outputs.IMAGE_TAG }}"
          echo "æ­£åœ¨æ£€æŸ¥é•œåƒ: ${IMAGE_NAME}"
          # ç›´æŽ¥åˆ©ç”¨ docker manifest inspect çš„é€€å‡ºç åˆ¤æ–­
          if docker manifest inspect "${IMAGE_NAME}" >/dev/null 2>&1; then
            echo "image_exists=true" >> $GITHUB_OUTPUT
            echo "é•œåƒå·²å­˜åœ¨ã€‚å¦‚éœ€è¦†ç›–ï¼Œè¯·åœ¨è¿è¡Œæ—¶å°† 'overwrite_existing' è®¾ä¸º 'true'ã€‚"
          else
            echo "image_exists=false" >> $GITHUB_OUTPUT
            echo "é•œåƒä¸å­˜åœ¨ï¼Œå°†ç»§ç»­æž„å»ºã€‚"
          fi

      # 5. ä¼˜åŒ–ï¼šå°†æž„å»ºé€»è¾‘æ”¾åœ¨ä¸€ä¸ªå•ç‹¬çš„ job æˆ–æ­¥éª¤ç»„ä¸­ï¼Œå¹¶ä½¿ç”¨ç»Ÿä¸€çš„ if æ¡ä»¶
      #    è¿™é‡Œæˆ‘ä»¬ä¸ºæ¯ä¸ªéœ€è¦æž„å»ºçš„æ­¥éª¤æ·»åŠ ç»Ÿä¸€çš„ if æ¡ä»¶
      #    æž„å»ºæ¡ä»¶ï¼šç”¨æˆ·é€‰æ‹©è¦†ç›–ï¼Œæˆ–è€…ï¼ˆç”¨æˆ·ä¸é€‰æ‹©è¦†ç›– ä¸” é•œåƒä¸å­˜åœ¨ï¼‰
      - name: Update package.json with specific version
        id: update_package
        if: github.event.inputs.overwrite_existing || steps.check_image.outputs.image_exists == 'false'
        run: |
          NPM_VERSION="${{ steps.prepare.outputs.NPM_VERSION }}"
          echo "æ­£åœ¨æ›´æ–° package.jsonï¼Œä½¿ç”¨ç‰ˆæœ¬: $NPM_VERSION"
          jq --arg version "$NPM_VERSION" '.dependencies["@musistudio/claude-code-router"] = $version' package.json > package.json.tmp && mv package.json.tmp package.json
          echo "æ›´æ–°åŽçš„ package.json:"
          cat package.json

      - name: Set up Docker Buildx
        id: setup_buildx
        if: github.event.inputs.overwrite_existing || steps.check_image.outputs.image_exists == 'false'
        uses: docker/setup-buildx-action@v3

      # 6. ä¼˜åŒ–ï¼šæž„å»ºå’ŒæŽ¨é€æ­¥éª¤ (ç§»é™¤äº† determine_build å’Œ prep_names æ­¥éª¤)
      - name: Build and push Docker image
        id: build_and_push
        # ä½¿ç”¨ä¸Žä¸Šé¢ç›¸åŒçš„ã€æ›´ç®€æ´çš„æ¡ä»¶
        if: github.event.inputs.overwrite_existing || steps.check_image.outputs.image_exists == 'false'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ghcr.io/${{ steps.prepare.outputs.OWNER_LC }}/ccr:${{ steps.prepare.outputs.IMAGE_TAG }}
            ghcr.io/${{ steps.prepare.outputs.OWNER_LC }}/ccr:latest
          # ä¼˜åŒ–ï¼šç›´æŽ¥ä½¿ç”¨å¸ƒå°”å€¼è¾“å…¥ï¼Œç§»é™¤äº†å¤šä½™çš„ CACHE_BUST
          no-cache: ${{ github.event.inputs.skip_cache }}

      # 7. ä¼˜åŒ–ï¼šä½¿ç”¨ outcome çŠ¶æ€ç”Ÿæˆæ›´å¯é çš„æ‘˜è¦
      - name: Generate build summary
        if: always() # ç¡®ä¿æ­¤æ­¥éª¤æ€»æ˜¯è¿è¡Œ
        run: |
          echo "## é•œåƒæž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "- **è¯·æ±‚ç‰ˆæœ¬**: `${{ github.event.inputs.version_to_build }}`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ˜¯å¦è¦†ç›–å·²æœ‰é•œåƒ**: `${{ github.event.inputs.overwrite_existing }}`" >> $GITHUB_STEP_SUMMARY
          echo "- **æ˜¯å¦è·³è¿‡ç¼“å­˜**: `${{ github.event.inputs.skip_cache }}`" >> $GITHUB_STEP_SUMMARY
          
          # ä½¿ç”¨ steps.build_and_push.outcome åˆ¤æ–­æž„å»ºæ˜¯å¦è¢«æ‰§è¡Œ
          # outcome çš„å€¼å¯ä»¥æ˜¯ success, failure, cancelled, or skipped
          if [ "${{ steps.build_and_push.outcome }}" == "skipped" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŸ¡ **æž„å»ºè·³è¿‡**" >> $GITHUB_STEP_SUMMARY
            echo "åŽŸå› æ˜¯é•œåƒ `${{ jobs.build-and-push.outputs.image_tag }}` å·²å­˜åœ¨ï¼Œä¸”æœªé€‰æ‹©è¦†ç›–ã€‚" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.build_and_push.outcome }}" == "success" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "âœ… **æž„å»ºå¹¶æŽ¨é€æˆåŠŸ**" >> $GITHUB_STEP_SUMMARY
            echo "é•œåƒå·²æŽ¨é€åˆ°ä»¥ä¸‹åœ°å€:" >> $GITHUB_STEP_SUMMARY
            echo "  - `ghcr.io/${{ jobs.build-and-push.outputs.owner_lc }}/ccr:${{ jobs.build-and-push.outputs.image_tag }}`" >> $GITHUB_STEP_SUMMARY
            echo "  - `ghcr.io/${{ jobs.build-and-push.outputs.owner_lc }}/ccr:latest`" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.prepare.outcome }}" == "failure" ]; then
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **æž„å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "å¤±è´¥åŽŸå› ï¼šç‰ˆæœ¬å·æ ¼å¼ä¸æ­£ç¡®ã€‚" >> $GITHUB_STEP_SUMMARY
          else
            echo "---" >> $GITHUB_STEP_SUMMARY
            echo "âŒ **æž„å»ºå¤±è´¥**" >> $GITHUB_STEP_SUMMARY
            echo "è¯·æ£€æŸ¥å·¥ä½œæµæ—¥å¿—ä»¥èŽ·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯ã€‚" >> $GITHUB_STEP_SUMMARY
          fi
