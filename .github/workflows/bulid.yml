jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # éªŒè¯æœ¬å·æ ¼å¼
      - name: Validate version format
        id: validate_version
        run: |
          version="${{ github.event.inputs.version_to_build }}"
          if [[ ! "$version" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ æ— æ•ˆçš„ç‰ˆæœ¬æ ¼å¼: $version"
            echo "æœŸæœ›æ ¼å¼ä¸º: v1.2.3"
            exit 1
          fi
          echo "âœ… ç‰ˆæœ¬æ ¼å¼æœ‰æ•ˆ: $version"
          echo "IMAGE_TAG=$version" >> $GITHUB_OUTPUT

      # 3. ç™»å½•åˆ° GitHub Container Registry (GHCR)
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # 4. æ£€æŸ¥é•œåƒæ˜¯å¦å·²å­˜åœ¨ (é™¤éžç”¨æˆ·é€‰æ‹©è¦†ç›–)
      - name: Check if Docker image already exists on GHCR
        id: check_image
        if: github.event.inputs.overwrite_existing == 'false'
        run: |
          IMAGE_TAG="${{ steps.validate_version.outputs.IMAGE_TAG }}"
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          REPO="ghcr.io/${OWNER_LC}/ccr"
          echo "æ­£åœ¨æ£€æŸ¥é•œåƒ: ${REPO}:${IMAGE_TAG}"
          if docker manifest inspect "${REPO}:${IMAGE_TAG}" >/dev/null 2>&1; then
            echo "é•œåƒ ${REPO}:${IMAGE_TAG} å·²å­˜åœ¨ã€‚å¦‚éœ€è¦†ç›–ï¼Œè¯·åœ¨è¿è¡Œæ—¶å°† 'overwrite_existing' è®¾ä¸º 'true'ã€‚"
            echo "image_exists=true" >> $GITHUB_OUTPUT
          else
            echo "é•œåƒ ${REPO}:${IMAGE_TAG} ä¸å­˜åœ¨ï¼Œå°†ç»§ç»­æž„å»ºã€‚"
            echo "image_exists=false" >> $GITHUB_OUTPUT
          fi

      # å†³å®šæ˜¯å¦éœ€è¦æ‰§è¡Œæž„å»º
      - name: Determine if build should run
        id: determine_build
        run: |
          if [ "${{ github.event.inputs.overwrite_existing }}" == "true" ] || [ "${{ steps.check_image.outputs.image_exists }}" == "false" ]; then
            echo "å†³å®šæ‰§è¡Œæž„å»ºã€‚"
            echo "should_build=true" >> $GITHUB_OUTPUT
          else
            echo "å†³å®šè·³è¿‡æž„å»ºã€‚"
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

      # package.json ä¸­çš„ä¾èµ–ç‰ˆæœ¬
      - name: Update package.json with specific version
        if: steps.determine_build.outputs.should_build == 'true'
        run: |
          VERSION="${{ steps.validate_version.outputs.IMAGE_TAG }}"
          NPM_VERSION=${VERSION#v}
          echo "æ­£åœ¨æ›´æ–° package.jsonï¼Œä½¿ç”¨ç‰ˆæœ¬: $NPM_VERSION"
          jq --arg version "$NPM_VERSION" '.dependencies["@musistudio/claude-code-router"] = $version' package.json > package.json.tmp && mv package.json.tmp package.json
          echo "æ›´æ–°åŽçš„ package.json:"
          cat package.json

      # è®¾ç½® Docker Buildx
      - name: Set up Docker Buildx
        if: steps.determine_build.outputs.should_build == 'true'
        uses: docker/setup-buildx-action@v3

      # å‡†å¤‡å°å†™çš„ä»“åº“æ‰€æœ‰è€…åç§° âœ¨
      - name: Prepare lowercase owner name
        id: prep_names
        if: steps.determine_build.outputs.should_build == 'true'
        run: |
          OWNER_LC=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          echo "OWNER_LC=${OWNER_LC}" >> $GITHUB_OUTPUT

      # æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ  ä¿®å¤ç”¨æˆ·åå¤§å°å†™é—®é¢˜
      - name: Build and push Docker image to GHCR
        if: steps.determine_build.outputs.should_build == 'true'
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          build-args: |
            CACHE_BUST=${{ github.run_number }}-${{ steps.validate_version.outputs.IMAGE_TAG }}
          # ðŸ‘‡ ä½¿ç”¨æ–°å‡†å¤‡çš„å°å†™åç§°
          tags: |
            ghcr.io/${{ steps.prep_names.outputs.OWNER_LC }}/ccr:${{ steps.validate_version.outputs.IMAGE_TAG }}
            ghcr.io/${{ steps.prep_names.outputs.OWNER_LC }}/ccr:latest
          no-cache: ${{ github.event.inputs.skip_cache == 'true' }}

      #ç”Ÿæˆæž„å»ºæ‘˜è¦ 
       - name: Build summary
        if: always()
        run: |
          echo "## æž„å»ºæ‘˜è¦" >> $GITHUB_STEP_SUMMARY
          echo "- **æž„å»ºç‰ˆæœ¬**: ${{ github.event.inputs.version_to_build }}" >> $GITHUB_STEP_SUMMARY
          echo "- **æ˜¯å¦è¦†ç›–å·²æœ‰é•œåƒ**: ${{ github.event.inputs.overwrite_existing }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.overwrite_existing }}" == "false" ]; then
            echo "- **é•œåƒæ˜¯å¦å·²å­˜åœ¨**: ${{ steps.check_image.outputs.image_exists || 'false' }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "---" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.determine_build.outputs.should_build }}" == "true" ]; then
            echo "âœ… **æž„å»ºå·²æ‰§è¡Œ**" >> $GITHUB_STEP_SUMMARY
            echo "- **æœ€ç»ˆé•œåƒæ ‡ç­¾**: ${{ steps.validate_version.outputs.IMAGE_TAG }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **æž„å»ºå·²è·³è¿‡**" >> $GITHUB_STEP_SUMMARY
          fi